<!DOCTYPE html>
<html>
<head>
  <link href="css/lookup.css" type="text/css" rel="stylesheet">
  <title>查詢</title>
</head>
<body>
  <!-- <h1>查詢頁面</h1> -->
  <div id="load">
    <div>中</div>
    <div>果</div>
    <div>結</div>
    <div>詢</div>
    <div>查</div>
  </div>
  <script src="https://cdn.socket.io/4.5.3/socket.io.min.js"
    integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
    crossorigin="anonymous"></script>
  <script src='//cdn.jsdelivr.net/npm/sweetalert2@11'></script>
  <script src="js/header.js"></script>
  <script>
    if (window.localStorage.getItem('user_id') === null || window.localStorage.getItem('access_token') === null) {
      Swal.fire({
        icon: 'info',
        title: '請先登入或註冊',
        showConfirmButton: false,
        timer: 1200,
      });
      setTimeout(() => {
        window.location.href = `${DNS}/member.html`;
      }, 1600);
    }
    const STATUS = {
      FAIL: -1,
      STANDBY: 0,
      SUCCESS: 1,
      PAID: 2,
    };
    const access_token = window.localStorage.getItem('access_token');

    const socket = io(CONSUMER_DNS, {
      auth: {
        token: access_token
      }
    });
    socket.on('jwt', (jwt) => {
      // console.log('jwt', jwt);
      window.localStorage.setItem('pay_token', jwt); // Save token
    });
    socket.on('notify', (result) => {
      console.log('Result is', result);
      if (result === STATUS.SUCCESS) {
        Swal.fire({
          icon: 'success',
          title: '搶購成功',
          showConfirmButton: false,
          timer: 2000,
        });
        // 搶購成功後，導向結帳頁面
        setTimeout(() => {
          window.location.href = `${DNS}/checkout.html`;
        }, 2500);
      }
      if (result === STATUS.STANDBY) {
        Swal.fire({
          icon: 'success',
          title: '候補中',
          showConfirmButton: false,
          timer: 2500,
        });
      }
      if (result === STATUS.FAIL) {
        Swal.fire({
          icon: 'info',
          title: '搶購失敗',
          showConfirmButton: false,
          timer: 2000,
        });
        // 搶購失敗後，導向失敗頁面
        setTimeout(() => {
          window.location.href = `${DNS}/failure.html`;
        }, 2500);
      }
    });
    socket.on('connect_error', () => {
      console.error('connect error')
    })
  </script>
</body>
</html>